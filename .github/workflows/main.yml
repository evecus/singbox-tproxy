name: Release TProxy
on:
  push:
    tags: ["v*"]

jobs:
  release:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: amd64
            os: linux
          - arch: arm64
            os: linux
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v4
        with:
          go-version: '1.22' # 建议使用较新版本以支持 sing-box 依赖

      - name: Prepare Deps
        run: |
          go mod init sing-box-tproxy || true
          go mod tidy

      - name: Build
        run: |
          CGO_ENABLED=0 GOOS=${{ matrix.os }} GOARCH=${{ matrix.arch }} \
          go build -v -trimpath -ldflags "-s -w -buildid=" \
          -tags "with_quic,with_dhcp,with_wireguard,with_ech,with_utls" \
          -o sing-box-tproxy-${{ matrix.arch }} main.go

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: sing-box-tproxy-${{ matrix.arch }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
