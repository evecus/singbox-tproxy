name: Build Integrated TProxy

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Download Sing-box Core
      run: |
        # 自动抓取最新版并存为 main.go 需要的 sing-box-core
        LATEST_TAG=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | jq -r .tag_name | sed 's/v//')
        URL="https://github.com/SagerNet/sing-box/releases/download/v${LATEST_TAG}/sing-box-${LATEST_TAG}-linux-arm64.tar.gz"
        curl -L $URL -o sb.tar.gz
        tar -xzf sb.tar.gz
        # 移动二进制文件并命名为 embed 目标
        find . -name "sing-box" -type f -exec cp {} ./sing-box-core \;

    - name: Compile
      run: |
        GOOS=linux GOARCH=arm64 go build -o sing-box-tproxy-arm64 main.go

    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: sing-box-tproxy-arm64
        path: sing-box-tproxy-arm64
