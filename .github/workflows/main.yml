name: Build Custom Sing-box

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        include:
          - goarch: amd64
          - goarch: arm64

    steps:
      - name: Checkout Patches
        uses: actions/checkout@v4

      - name: Clone Source
        run: git clone --depth 1 https://github.com/SagerNet/sing-box.git sb_src

      - name: Inject
        run: |
          # 1. 复制注入代码文件
          cp patches/inject.go sb_src/cmd/sing-box/inject.go
          
          # 2. 在 main.go 的 import 块中注入 "os" 包
          # sing-box 的 main.go 通常已有 import 块，我们强制在第一行 import 后面插入 "os"
          sed -i '/import (/a \	"os"' sb_src/cmd/sing-box/main.go || sed -i 's/package main/package main\n\nimport "os"/' sb_src/cmd/sing-box/main.go

          # 3. 注入逻辑：在 main 函数开头预处理参数
          # 注意：这里使用了更稳健的插入方式，并确保引用了预期的变量名
          sed -i '/func main() {/a \	for i, arg := range os.Args { if arg == "--lan" && i+1 < len(os.Args) { LanAddr = os.Args[i+1]; os.Args = append(os.Args[:i], os.Args[i+2:]...); break } }; AutoNetworkManager(os.Args)' sb_src/cmd/sing-box/main.go

      - name: Build
        run: |
          cd sb_src
          CGO_ENABLED=0 GOOS=linux GOARCH=${{ matrix.goarch }} go build -v -trimpath -ldflags "-s -w" -tags "with_gvisor,with_quic,with_utls,with_clash_api" -o ../sb-linux-${{ matrix.goarch }} ./cmd/sing-box

      - name: Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        with:
          files: sb-linux-*
          tag_name: latest
          name: "Custom Sing-box with Auto-TProxy"
          body: "使用方法: sudo ./sb-linux-xxx run --lan 10.0.0.0/24 -c config.json"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
