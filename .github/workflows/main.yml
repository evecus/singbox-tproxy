name: Build Custom Sing-box

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        goarch: [amd64, arm64]

    steps:
      - name: Checkout Your Patches
        uses: actions/checkout@v4

      - name: Clone Official Source
        run: git clone --depth 1 https://github.com/SagerNet/sing-box.git sb_src

      - name: Inject Logic
        run: |
          # 1. 拷贝注入代码
          cp patches/inject.go sb_src/cmd/sing-box/inject.go
          
          # 2. 修改 main.go
          cd sb_src/cmd/sing-box
          
          # 清除可能存在的旧注入（幂等性处理），防止重复构建报错
          sed -i '/AutoNetworkManager/d' main.go
          
          # 使用 perl 插入 import "os" 到 package main 后面（如果不存在）
          perl -i -pe 's/^package main\s*$/package main\n\nimport "os"/' main.go
          
          # 使用 perl 替换 func main() { 块
          # 这里的逻辑是：匹配 func main() { 然后在后面接上参数提取和 AutoNetworkManager 调用
          perl -i -0777 -pe 's/func main\(\) \{/func main() {\n\tconfigPath := "config.json"\n\tfor i, arg := range os.Args {\n\t\tif (arg == "-c" || arg == "--config") && i+1 < len(os.Args) {\n\t\t\tconfigPath = os.Args[i+1]\n\t\t}\n\t}\n\tAutoNetworkManager(configPath)/g' main.go

          # 验证结果（调试用）
          head -n 20 main.go

      - name: Build Core
        run: |
          cd sb_src
          CGO_ENABLED=0 GOOS=linux GOARCH=${{ matrix.goarch }} go build -v -trimpath \
            -ldflags "-s -w" \
            -tags "with_gvisor,with_quic,with_utls,with_clash_api" \
            -o ../sb-linux-${{ matrix.goarch }} ./cmd/sing-box

      - name: Release and Upload Assets
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        with:
          files: sb-linux-*
          tag_name: latest
          name: "Custom Sing-box (Fixed TProxy/DNS)"
          body: |
            ### 定制版 Sing-box
            - **固定 LAN**: 10.0.0.0/24
            - **自动化**: 自动配置 nftables 和 策略路由
            - **用法**: `sudo ./sb-linux-amd64 run -c config.json`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
